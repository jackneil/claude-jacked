# Session Indexing Improvements - Design Document

## Status: Research Complete, Implementation Pending

## Problem Statement

Current jacked indexing has two major issues:
1. **Context window explosion** - Retrieving full transcripts (50K-200K chars) blows up context
2. **Missing gold data** - We're ignoring Claude's compaction summaries which are perfect for search

## Discovery: Claude Code Session JSONL Structure

### Message Types Found

| Type | Description | Currently Indexed | Should Index |
|------|-------------|-------------------|--------------|
| `user` | User messages | ✅ Yes | ✅ Yes (for intent) |
| `assistant` | Claude responses | ✅ Yes (full) | ⚠️ Maybe trim |
| `summary` | **Compaction summaries** | ❌ NO | ✅ **YES - PRIMARY** |
| `file-history-snapshot` | File backup tracking | ❌ No | ❌ No |
| `system` | Metrics (turn_duration, etc) | ❌ No | ❌ No |
| `progress` | Hook progress events | ❌ No | ❌ No |

### The Summary Gold Mine

Claude Code stores compaction summaries directly in session JSONL files:

```json
{"type":"summary","summary":"Backfill Command Deduplication Logic Check","leafUuid":"aa638c9a-..."}
{"type":"summary","summary":"Smart install prompt with Windows env var handling","leafUuid":"cf910ea9-..."}
{"type":"summary","summary":"Anesthesia Billing: Units & Conversion Factors","leafUuid":"56037c44-..."}
```

Each summary:
- Is 3-10 words (tiny - ~50 bytes)
- Captures the essence of what work was done
- Is generated by Claude during compaction
- Links to a specific message via `leafUuid`

A single session can have 20-50+ summaries representing different work chunks.

### Real Examples from Production Sessions

**From claude-jacked project:**
```
"Backfill Command Deduplication Logic Check"
"Backfill deduplication and Windows executable path issues"
"Smart install prompt with Windows env var handling"
"Improve Install Prompt & Handle Windows Git Bash Env Vars"
```

**From other projects:**
```
"Avid Asset Purchase and Sale Deal Summary"
"Anesthesia Billing: Units & Conversion Factors"
"JSON to CSV Extraction Tool Implementation"
```

## Current Architecture Problems

### 1. Indexing (what we store)
- **Current**: Chunks full transcript at 4KB, stores ~25-50 chunks per session
- **Problem**: Lots of noise, tool outputs, XML tags, etc.
- **Better**: Store summaries as primary index (1 vector per summary)

### 2. Retrieval (what we return)
- **Current**: `jacked retrieve` returns ENTIRE transcript
- **Problem**: 50K-200K chars = 12K-50K tokens = context explosion
- **Better**: Return summaries, optionally expand specific sections

### 3. Search (how we find)
- **Current**: Semantic search on user messages (intent_text)
- **Problem**: User messages can be terse, miss context
- **Better**: Search summaries - they're already distilled semantic descriptions

## Proposed Architecture

### Phase 1: Add Summary Indexing
```python
# In transcript.py - extract summaries
if msg_type == "summary":
    summaries.append({
        "text": data.get("summary"),
        "leaf_uuid": data.get("leafUuid"),
    })
```

### Phase 2: Change Retrieval Strategy
```python
# Instead of full transcript, return summaries
def retrieve_summaries(session_id: str) -> list[str]:
    """Return just the summary texts for a session."""
    ...
```

### Phase 3: Update SKILL.md Instructions
Tell Claude to:
1. Search by description (uses summary embeddings)
2. Get session summaries (tiny, fits in context)
3. Optionally expand specific sections if needed

## Context Window Math

| Approach | Size per Session | 5 Sessions |
|----------|------------------|------------|
| Full transcript | 50K-200K chars | 250K-1M chars (OVERFLOW) |
| Summaries only | 500-2000 chars | 2.5K-10K chars (FINE) |

## Hooks Investigation

### PreCompact Hook
- **Exists**: Yes, fires before compaction
- **Provides**: `transcript_path`, `trigger` (manual/auto), `session_id`
- **Use case**: Could save full transcript before compaction

### PostCompact Hook
- **Exists**: NO (requested in GitHub issue #17237)
- **Impact**: Can't capture summary at generation time
- **Workaround**: Summaries are written to JSONL anyway, we can read them

## Files to Modify

1. `jacked/transcript.py` - Add summary extraction to `parse_jsonl_file()`
2. `jacked/indexer.py` - Add summary points alongside intent/chunk points
3. `jacked/retriever.py` - Add `retrieve_summaries()` method
4. `jacked/cli.py` - Add `--summaries` flag to retrieve command
5. `skills/jacked/SKILL.md` - Update instructions to use summaries

## Open Questions

1. Should we still index full transcripts for detailed retrieval, or just summaries?
2. How to handle sessions with no summaries (never compacted)?
3. Should we generate our own summaries for non-compacted sessions?
4. What's the right balance of summary vs transcript in retrieved context?

## Next Steps

1. ~~Document findings~~ (this doc)
2. Fix install issues first (separate PR)
3. Implement summary extraction
4. Update indexing to include summaries
5. Update retrieval to return summaries by default
6. Update SKILL.md instructions
7. Re-backfill to index summaries from existing sessions

## References

- Claude Code Hooks: https://code.claude.com/docs/en/hooks.md
- PostCompact feature request: https://github.com/anthropics/claude-code/issues/17237
- Session JSONL location: `~/.claude/projects/{encoded-repo-path}/{session-id}.jsonl`
